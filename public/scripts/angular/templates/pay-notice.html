<style>
.invoice-info {line-height: 30px; padding: 10px 10px 10px 20px;}
.invoice-info b {font-size: 14px;}
.invoice-info ul {padding: 15px 0; margin: 0; border: 1px solid #ddd; border-radius: 5px; width: 100%;}
.invoice-info li {padding: 0 15px; display: flex;}
.invoice-info li span {flex: 1;}
.invoice-info input[type="text"] {width: 100%; height: 20px; border: none; border-bottom: 1px solid #999;}
.invoice-info input[type="radio"] {position: static; opacity: 1; left: 0; vertical-align: text-bottom; margin-right: 5px;}
</style>
<div class="wrapper bg-white padding-15 margin-top-20 margin-bottom-50">
    <div class="container-fluid">
        <div class="row">
            <ul class="breadcrumb">
                <li><a href="#/">首页</a></li>
                <li>付款通知书管理</li>
            </ul>
        </div>
        <div class="row margin-bottom-10">
            <div class="col-xs-1"><a class="btn btn-sm btn-success" id="add"><i class="fa fa-plus"></i> 新增付款通知书</a></div>
        </div>
        <div class="row">
            <div class="col-xs-12">
                <div class="bordered border-color-gray"><div id="grid"></div></div>
            </div>
        </div>
    </div>
</div>
<script>
$(function() {
    var pData = new kendo.data.DataSource(),
        cData = new kendo.data.DataSource(),
        power = +$('meta[name="_sessionPower"]').attr('content');

    var autoData = [];
    var grid = $('#grid').kendoGrid({
        dataSource: {
            transport: {
                read: function (option) {
                    $.$ajax({
                        url: '/finance/pay-notice-json-list',
                        type: 'GET',
                        dataType: 'json',
                        success: function (res) {
                            res.forEach(function (v) {
                                var desc = v.invoice_desc.split('|');
                                if (desc[0] && !autoData.has({name: desc[0]})) autoData.push({name: desc[0], data: desc});
                            });
                            option.success(res);
                        }
                    })
                }
            },
            schema: {
                model: {
                    id: 'id'
                }
            },
            pageSize: 10
        },
        scrollable: false,
        pageable: true,
        columns: [
            {field: 'user_name', title: '申请人', width: 80},
            {field: 'belong', title: '归属公司'},
            {field: 'company_name', title: '付款单位'},
            {field: 'amount', title: '付款金额'},
            {field: 'person_name', title: '上岗人选'},
            {field: 'job_name', title: '上岗职位'},
            {field: 'created_at', title: '提交时间', template: getDate('created_at'), width: 80},
            {field: 'status', title: '审核状态', template: getStatus},
            {field: 'need_invoice', title: '是否开票', template: getNeedInvoice},
            {field: 'invoice_type', title: '开票信息', template: getInvoiceInfo},
            {title: '操作', template: getButtons, width: 135}
        ]
    }).data('kendoGrid');

    function getStatus(item) {
        return item.status == '1' ? '<span class="green">已审核</span>' : '<span class="dark-gray">未审核</span>';
    }

    function getNeedInvoice(item) {
        return item.need_invoice == 0 ? '<span class="dark-gray">不开票</span>' : '<span class="dark-yellow">开票</span>';
    }

    function getInvoiceInfo(item) {
        return item.need_invoice == 1 ? '<span class="pointer dark-orange _view" data-id="{0}">[查看开票信息]</span>'.format(item.id) : '无';
    }

    function getDate(field) {
        return function (item) {
            return new Date(item[field].replace(/-/g, '/')).format();
        }
    }

    function getButtons(item) {
        var auditBtn = '';
        if (power > 8) {
            auditBtn = '<a class="btn btn-success btn-xs margin-right-5 _audit" title="审核" data-id="{0}" {1}><i class="fa fa-check"></i></a>'.format(item.id, item.status == 1 ? 'disabled' : '');
        }
        if (item.filepath) {
            return '<a class="btn btn-default btn-xs margin-right-5 _edit" data-id="{0}"><i class="fa fa-pencil"></i></a>\
                    <a class="btn btn-danger btn-xs margin-right-5 _delete" data-id="{0}"><i class="fa fa-trash-o"></i></a>\
                    <a class="btn btn-success btn-xs margin-right-5" href="/file/download-file?path={1}&coded=1&name={2}" target="_blank" title="下载附件"><i class="fa fa-download"></i></a> {3}'.format(item.id, item.filepath, item.filename, auditBtn);
        } else {
            return '<a class="btn btn-default btn-xs margin-right-5 _edit" data-id="{0}"><i class="fa fa-pencil"></i></a>\
                    <a class="btn btn-danger btn-xs margin-right-5 _delete" data-id="{0}"><i class="fa fa-trash-o"></i></a>\
                    <a class="btn btn-success btn-xs margin-right-5" disabled title="下载附件"><i class="fa fa-download"></i></a> {1}'.format(item.id, auditBtn)
        }
    }

    $('#add').click(function () {
        initDialog(null);
    });

    $('#grid').delegate('._view', 'click', function() {
        var id = $(this).data('id'), item = grid.dataSource.get(id), desc = item.invoice_type == 1 ? ['增值税普通发票'] : ['增值税专用发票'];
        desc = desc.concat(item.invoice_desc.split('|'));
        $.$modal.dialog({
            title: '开票信息',
            destroy: true,
            content: '<ul class="list-group"></ul>',
            footer: false,
            onLoaded: function () {
                var dom = this.dom, text = ['开票类型', '开票名称', '纳税人识别号', '公司地址', '公司电话', '开户行', '银行帐号'], li = [];
                text.forEach(function (v, i) {
                    li.push('<li class="list-group-item"><span class="dark-gray margin-right-10">{0}:</span>{1}</li>'.format(v, desc[i]));
                });
                dom.find('ul').html(li.join(''));
            }
        }).show();
    });

    $('#grid').delegate('a._edit', 'click', function() {
        var id = $(this).data('id'), item = grid.dataSource.get(id);
        initDialog(item);
    });

    $('#grid').delegate('a._audit', 'click', function() {
        var id = $(this).data('id');
        $.$modal.confirm('确定要通过审核吗？', function (isOk) {
            if (!isOk) return;
            $.$ajax({
                url: '/finance/audit-pay-notice',
                type: 'POST',
                dataType: 'json',
                data: {id: id},
                success: function (res) {
                    if (res > 0) {
                        grid.dataSource.read();
                    }
                }
            });
        });
    });

    $('#grid').delegate('a._delete', 'click', function() {
        var id = $(this).data('id');
        $.$modal.confirm('确定要删除吗？', function (isOk) {
            if (!isOk) return;
            $.$ajax({
                url: '/finance/delete-pay-notice',
                type: 'POST',
                dataType: 'json',
                data: {id: id},
                success: function (res) {
                    if (res > 0) {
                        grid.dataSource.read();
                    }
                }
            });
        });
    });

    function initDialog(data) {
        var required = ['job_id', 'company_id', 'person_id', 'user_id', 'belong', 'amount', 'need_invoice', 'filepath'];
        $.$modal.dialog({
            title: '{0}付款通知书'.format(data ? '编辑' : '新建'),
            size: 'lg',
            content: '<div id="dlg_ctn" class="padding-right-15" style="max-height:400px;overflow-y:auto;">' +
            '<form class="form form-horizontal">' +
                '<div class="form-group">' +
                    '<div class="col-xs-6 no-padding">' +
                        '<label class="control-label col-xs-3"><span class="red">*</span> 职位名称:</label>' +
                        '<div class="col-xs-9"><select id="job_id" class="form-control size-full"></select></div>' +
                    '</div>' +
                    '<div class="col-xs-6 no-padding">' +
                        '<label class="control-label col-xs-3"><span class="red">*</span> 候选人:</label>' +
                        '<div class="col-xs-9"><select id="person_id" class="form-control size-full"></select></div>' +
                    '</div>' +
                '</div>' +
                '<div class="form-group">' +
                    '<div class="col-xs-6 no-padding">' +
                        '<label class="control-label col-xs-3"><span class="red">*</span> 申请人:</label>' +
                        '<div class="col-xs-9"><select id="user_id" class="form-control size-full"></select></div>' +
                    '</div>' +
                    '<div class="col-xs-6 no-padding">' +
                        '<label class="control-label col-xs-3"><span class="red">*</span> 归属公司:</label>' +
                        '<div class="col-xs-9"><select id="belong" class="form-control size-full"></select></div>' +
                    '</div>' +
                '</div>' +
                '<div class="form-group">' +
                    '<div class="col-xs-6 no-padding">' +
                        '<label class="control-label col-xs-3"><span class="red">*</span> 付款金额:</label>' +
                        '<div class="col-xs-9"><div class="input-group"><input type="text" id="amount" class="form-control" /><span class="input-group-addon">元</span></div></div>' +
                    '</div>' +
                    '<div class="col-xs-6 no-padding">' +
                        '<label class="control-label col-xs-3"><span class="red">*</span> 是否开票:</label>' +
                        '<div class="col-xs-9"><select id="need_invoice" class="form-control size-full"></select></div>' +
                    '</div>' +
                '</div>' +
                '<div class="invoice-info" style="display: none;">' +
                '<ul>' +
                '<li><b>开票信息</b></li>' +
                '<li><em>开票类型：</em><span><label class="pointer"><input type="radio" name="invoice_type" value="1" checked>增值税普通发票</label><label class="pointer margin-left-20"><input type="radio" name="invoice_type" value="2">增值税专用发票</label></span></li>' +
                '<li><em>开票名称：</em><span><input type="text" class="full-width" id="invoice_name" /></span></li>' +
                '<li><em>纳税人识别号：</em><span><input type="text" /></span></li>' +
                '<li><em>公司地址：</em><span><input type="text" /></span></li>' +
                '<li><em>公司电话：</em><span><input type="text" /></span></li>' +
                '<li><em>开户行：</em><span><input type="text" /></span></li>' +
                '<li><em>银行帐号：</em><span><input type="text" /></span></li>' +
                '</ul>' +
                '</div>' +
                '<div class="form-group flex">' +
                    '<label class="control-label width-110 padding-right-15"><span class="red">*</span> 附件上传:</label>' +
                    '<div class="flex-1 padding-left-15 padding-right-15">' +
                        '<input type="file" id="file" /><input type="hidden" id="filepath" /><input type="hidden" id="filename" >' +
                        '<div id="file_ctn" class="padding-10" style="display: none;"><span></span></div>' +
                    '</div>' +
                '</div>' +
            '</form>' +
            '</div>',
            destroy: true,
            footer: {
                buttons: [
                    {
                        name: 'ok',
                        handler: function () {
                            var self = this, dom = self.dom, formData = {}, url = '/finance/save-pay-notice';
                            var job = $('#job_id', dom).data('kendoDropDownList').dataItem();
                            var person = $('#person_id', dom).data('kendoDropDownList').dataItem();
                            var user = $('#user_id', dom).data('kendoDropDownList').dataItem();
                            if (job && job.job_id) {
                                formData.job_id = job.job_id;
                                formData.job_name = job.job_name;
                                formData.company_id = job.company_id;
                                formData.company_name = job.company_name;
                            }
                            if (person && person.person_id) {
                                formData.person_id = person.person_id;
                                formData.person_name = person.person_name;
                            }
                            if (user && user.user_id) {
                                formData.user_id = user.user_id;
                                formData.user_name = user.user_name;
                            }

                            formData.status = 0;
                            formData.need_invoice = $('#need_invoice', dom).val();
                            formData.belong = $('#belong', dom).val();
                            formData.amount = $('#amount', dom).data('kendoNumericTextBox').value();

                            if (formData.need_invoice == 1) {
                                formData.invoice_type = $('input[name="invoice_type"]:checked', dom).val();
                                var desc = [];
                                $('.invoice-info input[type="text"]', dom).each(function (i, ipt) {
                                    desc.push($(ipt).val());
                                });
                                formData.invoice_desc = desc.join('|');
                            } else {
                                formData.invoice_desc = '';
                            }

                            formData.filepath = $('#filepath', dom).val();
                            formData.filename = $('#filename', dom).val();
                            console.log(formData);

                            var invalid = false;
                            required.forEach(function (n) {
                                if (formData[n] === '') invalid = true;
                            });
                            if (invalid) {
                                $.$modal.alert('信息填写不全，请补全后再保存');
                                return;
                            }

                            if (data && data.id) {
                                url = '/finance/edit-pay-notice';
                                formData.id = data.id;
                            }
                            $.$ajax({
                                url: url,
                                type: 'POST',
                                dataType: 'json',
                                data: {notice: formData},
                                success: function (res) {
                                    if (~~res > 0) {
                                        self.hide();
                                        grid.dataSource.read();
                                        $.$modal.alert('保存成功');
                                    } else {
                                        $.$modal.alert(res);
                                    }
                                }
                            })
                        }
                    },
                    {
                        name: 'cancel',
                        handler: function () {
                            this.hide();
                        }
                    }
                ]
            },
            onLoaded: function () {
                var self = this, dom = self.dom;
                var job = $('#job_id', dom).kendoDropDownList({
                    dataSource: {
                        transport: {
                            read: {
                                url: '/result/search-job-with-company'
                            }
                        },
                        serverFiltering: true
                    },
                    dataTextField: 'job_name',
                    dataValueField: 'job_id',
                    template: '#:job_name#<br><small class="dark-gray">#:company_name#</small>',
                    valueTemplate: '#:job_name# -- <small class="dark-gray">#:company_name#</small>',
                    filter: 'contains',
                    minLength: 2,
                    optionLabel: '请输入岗位或企业关键字查询',
                    popup: {
                        appendTo: dom
                    },
                    filtering: function(e) {
                        var filter = e.filter;
                        if (!filter || !filter.value) {
                            e.preventDefault();
                        }
                    },
                    change: function () {
                        var item = this.dataItem();
                        $.$ajax({
                            url: '/result/json-job-person-list',
                            type: 'GET',
                            dataType: 'json',
                            data: {job_id: item.job_id},
                            success: function (res) {
                                person.dataSource.data(res);
                                if (data && data.person_id) person.select(function(item) {
                                    return item.person_id == data.person_id;
                                })
                            }
                        });
                    }
                }).data('kendoDropDownList');

                var person = $('#person_id', dom).kendoDropDownList({
                    dataSource: [],
                    dataTextField: 'person_name',
                    dataValueField: 'person_id',
                    optionLabel: '请选择上岗候选人',
                    template: '#:person_name#  <small class="dark-gray">[入职日期：#:new Date(date).format()#]</small>',
                    valueTemplate: '#:person_name#  <small class="dark-gray">[入职日期：#:new Date(date).format()#]</small>',
                    popup: {
                        appendTo: dom
                    },
                }).data('kendoDropDownList');

                var user = $('#user_id', dom).kendoDropDownList({
                    dataSource: {
                        transport: {
                            read: {
                                url: '/result/json-user-list'
                            }
                        }
                    },
                    dataTextField: 'user_name',
                    dataValueField: 'user_id',
                    template: '<span style="font-size:12px;">#:user_name# -- #:group_name# -- #:area_name#</span>',
                    optionLabel: '请选择开票人',
                    filter: 'contains',
                    popup: {
                        appendTo: dom
                    },
                }).data('kendoDropDownList');

                var amount = $('#amount').kendoNumericTextBox({
                    spinners: false,
                    format: 'n2'
                }).data('kendoNumericTextBox');

                var need_invoice = $('#need_invoice', dom).kendoDropDownList({
                    dataSource: [{value: 0, text: '无需开票'}, {value: 1, text: '需要开票'}],
                    dataTextField: 'text',
                    dataValueField: 'value',
                    optionLabel: '请选择是否开票',
                    change: function () {
                        var value = this.value();
                        if (value == 1) {
                            $('.invoice-info', dom).show();
                        } else {
                            $('.invoice-info', dom).hide();
                        }
                    }
                }).data('kendoDropDownList');

                var belong = $('#belong', dom).kendoDropDownList({
                    dataSource: ["上海", "湖南", "武汉", "广州"],
                    optionLabel: '请选择归属公司'
                }).data('kendoDropDownList');

                $('#file', dom).kendoUpload({
                    async: {
                        saveUrl: '/file/upload-pay-notice?_token='+$('meta[name="_token"]').attr('content'),
                        saveField: 'file',
                    },
                    success: function (e) {
                        console.log(e);
                        $('#filepath', dom).val(e.response);
                        $('#filename', dom).val(e.files[0].name);
                        $('#file_ctn').show().find('span').text(e.files[0].name);
                    }
                });

                //with edit data
                if (data) {
                    var inited = false;
                    job.bind('dataBound', function () {
                        if (!inited && this.dataItems().length) {
                            job.select(function (item) {
                                return item.job_id == data.job_id;
                            });
                            inited = true;
                            job.trigger('change');
                        }
                    });
                    person.bind('dataBound', function () {
                        person.select(function(item) {
                            return item.person_id == data.person_id;
                        });
                    });
                    job.search(data.job_name);
                    user.bind('dataBound', function () {
                        user.select(function (item) {
                            return item.user_id == data.user_id;
                        });
                    });
                    need_invoice.select(function (item) {
                        return item.value == data.need_invoice;
                    });
                    need_invoice.trigger('change');
                    belong.select(function (item) {
                        return item == data.belong;
                    });
                    amount.value(data.amount);
                    if (data.need_invoice) {
                        var desc = data.invoice_desc.split('|');
                        $('input[name="invoice_type"][value="{0}"]'.format(data.invoice_type), dom).prop('checked', true);
                        $('.invoice-info input[type="text"]', dom).each(function (i, ipt) {
                            $(ipt).val(desc[i] || '');
                        });
                    }
                    if (data.filepath) {
                        $('#filepath', dom).val(data.filepath);
                        $('#filename', dom).val(data.filename);
                        $('#file_ctn').show().find('span').text(data.filename);
                    }
                }

                $('#invoice_name', dom).kendoAutoComplete({
                    dataSource: autoData.map(function (v) {
                        return v.name;
                    }),
                    select: function (e) {
                        var text = e.item.text();
                        if (autoData.has({name: text})) {
                            var desc = autoData[autoData.at({name: text})].data;
                            $('.invoice-info input[type="text"]', dom).each(function (i, ipt) {
                                if (i == 0) return;
                                $(ipt).val(desc[i] || '');
                            });
                        }
                    }
                });
            }
        }).show();
    }
});
</script>