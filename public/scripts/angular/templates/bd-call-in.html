<div class="wrapper bg-white padding-15 margin-top-20 margin-bottom-50">
    <div class="container-fluid">
        <div class="row">
            <ul class="breadcrumb">
                <li><a href="#/">首页</a></li>
                <li>CallIn管理</li>
            </ul>
        </div>
        <div class="row margin-bottom-10" power-checker allowed="2,10,99">
            <div class="col-xs-1"><a class="btn btn-sm btn-success" id="add"><i class="fa fa-plus"></i> 新增CallIn信息</a></div>
        </div>
        <div class="row">
            <div class="col-xs-12">
                <div class="bordered border-color-gray"><div id="grid"></div></div>
            </div>
        </div>
    </div>
</div>
<script>
$(function() {
    var pData = new kendo.data.DataSource(), cData = new kendo.data.DataSource();
    var power = $('meta[name="_sessionPower"]').attr('content');
    $.$ajax.get('/data/location.json', function (res) {
        pData.data(res.province);
        var citys = [];
        for (c in res.citys) {
            citys.push(res.citys[c]);
        }
        cData.data(citys);
    });

    var grid = $('#grid').kendoGrid({
        dataSource: {
            transport: {
                read: function (option) {
                    $.$ajax({
                        url: '/bd/json-call-in-list',
                        type: 'GET',
                        dataType: 'json',
                        success: function (res) {
                            option.success(res);
                        }
                    })
                }
            },
            schema: {
                model: {
                    id: 'id'
                }
            },
            pageSize: 10
        },
        scrollable: false,
        pageable: true,
        columns: [
            {field: 'company_name', title: '客户名称'},
            {field: 'job_need', title: '招聘职位'},
            {field: 'contact', title: '联系人'},
            {field: 'tel', title: '电话'},
            {field: 'email', title: '邮箱'},
            {field: 'industry', title: '所属行业'},
            {field: 'area', title: '所属地区'},
            {field: 'belong', title: '归属公司'},
            {field: 'description', title: '备注', template: '<div style="max-width:300px;overflow: hidden; text-overflow: ellipsis;white-space: nowrap;" title="#:description#"><span>#:description#</span></div>'},
            {field: 'created_at', title: '录入日期', template: getDate, width: 80}
        ].concat([2,10,99].indexOf(power) < 0 ? [] : [{title: '操作', template: '<a class="btn btn-default btn-xs margin-right-5 _edit" data-id="#:id#"><i class="fa fa-pencil"></i></a>\
                                        <a class="btn btn-danger btn-xs _delete" data-id="#:id#"><i class="fa fa-trash-o"></i></a>', width: 80}])
    }).data('kendoGrid');

    function getDate(item) {
        return new Date(item.created_at.replace(/-/g, '/')).format();
    }

    $('#add').click(function () {
        initDialog(null);
    });

    $('#grid').delegate('a._edit', 'click', function() {
        var id = $(this).data('id'), item = grid.dataSource.get(id);
        initDialog(item);
    });

    $('#grid').delegate('a._delete', 'click', function() {
        var id = $(this).data('id');
        $.$modal.confirm('确定要删除吗？', function (isOk) {
            if (!isOk) return;
            $.$ajax({
                url: '/bd/delete-call-in',
                type: 'POST',
                dataType: 'json',
                data: {id: id},
                success: function (res) {
                    if (res > 0) {
                        grid.dataSource.read();
                    }
                }
            });
        });
    });

    function initDialog(data) {
        var fields = [
            {id: 'company_name', is_select: 0, name: '公司名称', required: true},
            {id: 'job_need', is_select: 0, name: '招聘职位', required: true},
            {id: 'industry', is_select: 1, name: '所属行业', required: true},
            {id: 'area_p', is_select: 1, name: '所在地区', required: true},
            {id: 'area_c', is_select: 1, name: '所在地区', required: true},
            {id: 'belong', is_select: 1, name: '归属公司', required: true},
            {id: 'contact', is_select: 0, name: '联系人', required: true},
            {id: 'tel', is_select: 0, name: '电话', required: true},
            {id: 'email', is_select: 0, name: '邮箱', required: true},
            {id: 'description', is_select: 0, name: '备注', required: false},
        ];
        $.$modal.dialog({
            title: '{0}CallIn信息'.format(data ? '编辑' : '新建'),
            size: 'lg',
            content: '<div id="dlg_ctn" class="padding-right-15">' +
            '<form class="form form-horizontal">' +
                '<div class="form-group">' +
                    '<div class="col-xs-6 no-padding">' +
                        '<label class="control-label col-xs-4"><span class="red">*</span> 公司名称:</label>' +
                        '<div class="col-xs-8"><input type="text" id="company_name" class="form-control" /></div>' +
                    '</div>' +
                    '<div class="col-xs-6 no-padding">' +
                        '<label class="control-label col-xs-4"><span class="red">*</span> 招聘职位:</label>' +
                        '<div class="col-xs-8"><input type="text" id="job_need" class="form-control" /></div>' +
                    '</div>' +
                '</div>' +
                '<div class="form-group">' +
                    '<div class="col-xs-6 no-padding">' +
                        '<label class="control-label col-xs-4"><span class="red">*</span> 所属行业:</label>' +
                        '<div class="col-xs-8"><select id="industry" class="form-control size-full"></select></div>' +
                    '</div>' +
                    '<div class="col-xs-6 no-padding">' +
                        '<label class="control-label col-xs-4"><span class="red">*</span> 所在地区:</label>' +
                        '<div class="col-xs-8">' +
                            '<div class="col-xs-6 no-padding-left"><select id="area_p" class="form-control size-full"></select></div>' +
                            '<div class="col-xs-6 no-padding-right"><select id="area_c" class="form-control size-full"></select></div>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
                '<div class="form-group">' +
                    '<div class="col-xs-6 no-padding">' +
                        '<label class="control-label col-xs-4"><span class="red">*</span> 归属公司:</label>' +
                        '<div class="col-xs-8"><select id="belong" class="form-control size-full"></select></div>' +
                    '</div>' +
                    '<div class="col-xs-6 no-padding">' +
                        '<label class="control-label col-xs-4"><span class="red">*</span> 联系人:</label>' +
                        '<div class="col-xs-8"><input type="text" id="contact" class="form-control" /></div>' +
                    '</div>' +
                '</div>' +
                '<div class="form-group">' +
                    '<div class="col-xs-6 no-padding">' +
                        '<label class="control-label col-xs-4"><span class="red">*</span> 电话:</label>' +
                        '<div class="col-xs-8"><input type="text" id="tel" class="form-control" /></div>' +
                    '</div>' +
                    '<div class="col-xs-6 no-padding">' +
                        '<label class="control-label col-xs-4"><span class="red">*</span> 邮箱:</label>' +
                        '<div class="col-xs-8"><input type="text" id="email" class="form-control" /></div>' +
                    '</div>' +
                '</div>' +
                '<div class="form-group">' +
                    '<label class="control-label col-xs-2">备注:</label>' +
                    '<div class="col-xs-10"><textarea id="description" class="form-control" rows="3" style="resize: none;"></textarea></div>' +
                '</div>' +
            '</form>' +
            '</div>',
            destroy: true,
            footer: {
                buttons: [
                    {
                        name: 'ok',
                        handler: function () {
                            var self = this, dom = self.dom, formData = {}, url = '/bd/save-call-in';
                            for (var i = 0; i < fields.length; i++) {
                                var v = fields[i], $ele = $('#'+v.id, dom);
                                if (v.is_select) {
                                    formData[v.id] = $ele.data('kendoDropDownList').text();
                                } else {
                                    formData[v.id] = $ele.val();
                                }
                                if (!formData[v.id] && v.required) {
                                    $.$modal.alert(v.name + '不能为空');
                                    return;
                                }
                            }
                            formData.area = [formData.area_p, formData.area_c].join('-');
                            delete formData.area_p;
                            delete formData.area_c;
                            console.log(formData);
                            if (data && data.id) {
                                url = '/bd/edit-call-in';
                                formData.id = data.id;
                            }
                            $.$ajax({
                                url: url,
                                type: 'POST',
                                dataType: 'json',
                                data: {call_in: formData},
                                success: function (res) {
                                    if (~~res > 0) {
                                        self.hide();
                                        grid.dataSource.read();
                                        $.$modal.alert('保存成功');
                                    } else {
                                        $.$modal.alert(res);
                                    }
                                }
                            })
                        }
                    },
                    {
                        name: 'cancel',
                        handler: function () {
                            this.hide();
                        }
                    }
                ]
            },
            onLoaded: function () {
                var self = this, dom = self.dom;
                $('#industry', dom).kendoDropDownList({
                    dataSource: [
                        "互联网•游戏•软件",
                        "电子•通信•硬件",
                        "房地产•建筑•物业",
                        "金融",
                        "广告•传媒•教育•文化",
                        "制药•医疗,消费品",
                        "汽车•机械•制造",
                        "服务•外包•中介",
                        "交通•贸易•物流",
                        "能源•化工•环保",
                        "政府•农林牧渔•其他"
                    ],
                    optionLabel: '请选择',
                    value: data ? data.industry : ''
                });
                $('#area_p', dom).kendoDropDownList({
                    dataSource: pData,
                    dataValueField: 'id',
                    dataTextField: 'name',
                    optionLabel: '请选择',
                    change: function () {
                        var id = ~~this.value(), area_c_data = $('#area_c', dom).data('kendoDropDownList').dataSource;
                        if (id) {
                            cData.filter({field: 'provinceId', operator: 'eq', value: id});
                            area_c_data.data(cData.view().toJSON());
                        } else {
                            area_c_data.data([]);
                        }
                    }
                });
                $('#area_c', dom).kendoDropDownList({
                    dataSource: [],
                    dataValueField: 'id',
                    dataTextField: 'name',
                    optionLabel: '请选择'
                });
                $('#belong', dom).kendoDropDownList({
                    dataSource: ['上海', '湖南', '武汉', '广州'],
                    optionLabel: '请选择',
                    value: data ? data.belong : ''
                });
                if (data) {
                    fields.forEach(function(v) {
                        if (!v.is_select) {
                            $('#'+ v.id, dom).val(data[v.id]);
                        }
                    });
                    var areas = data.area ? data.area.split('-') : ['', '']
                    data.area_p = areas[0];
                    data.area_c = areas[1];
                    $('#area_p', dom).data('kendoDropDownList').select(function(item) {
                        return item.name == data.area_p;
                    });
                    $('#area_p', dom).data('kendoDropDownList').trigger('change');
                    $('#area_c', dom).data('kendoDropDownList').select(function(item) {
                        return item.name == data.area_c;
                    });
                }
            }
        }).show();
    }
});
</script>