<style>
tbody tr:nth-child(2n) td {background: #f9f9f9;}
.k-grid tbody tr td {border-width: 1px 0 0 1px;}
</style>
<div class="wrapper bg-white padding-15 margin-top-20 margin-bottom-50 box-shadow">
    <div class="container-fluid">
        <div class="row">
            <ul class="breadcrumb">
                <li><a href="#/">首页</a></li>
                <li>目标管理</li>
            </ul>
        </div>
        <div id="tabstrip">
            <ul>
                <li class="k-state-active">KPI目标</li>
                <li>业绩目标</li>
            </ul>
            <div>
                <div class="row margin-bottom-10 margin-top-10">
                    <div class="col-xs-1"><a class="btn btn-sm btn-success" id="add"><i class="fa fa-plus"></i> 新增目标</a></div>
                </div>
                <div class="row margin-bottom-10">
                    <div class="col-xs-12">
                        <div class="pull-left">
                            <div class="pull-left margin-left-10 form-control-static">查询月份：</div>
                            <div class="pull-left margin-left-10"><input type="text" name="sdate" id="sdate" class="size-120" placeholder="开始月份"></div>
                            <div class="pull-left margin-left-10 form-control-static"> ~ </div>
                            <div class="pull-left margin-left-10"><input type="text" name="edate" id="edate" class="size-120" placeholder="结束月份"></div>
                        </div>
                        <div class="pull-left margin-left-20"><select id="search_area"></select></div>
                        <div class="pull-left margin-left-20"><select id="search_group"></select></div>
                        <div class="pull-left margin-left-20"><select id="search_user"></select></div>
                        <div class="pull-left margin-left-10">
                            <button class="btn btn-sm btn-primary" id="search"><i class="fa fa-search"></i> 查询</button>
                        </div>
                    </div>
                </div>
                <div class="row margin-bottom-10">
                    <div class="col-xs-12">
                        <div class="bordered border-color-gray"><div id="grid"></div></div>
                    </div>
                </div>
                <div class="row margin-bottom-10">
                    <div class="col-xs-12">
                        提示：月份颜色显示为蓝色时可点击编辑（自己的目标并且目标月份尚未开始才可以编辑哦）
                    </div>
                </div>
            </div>
            <div>
                <div class="row margin-bottom-10 margin-top-10">
                    <div class="col-xs-1"><a class="btn btn-sm btn-success" id="addResultTarget"><i class="fa fa-plus"></i> 新增目标</a></div>
                </div>
                <div class="row margin-bottom-10">
                    <div class="col-xs-12">
                        <div class="bordered border-color-gray"><div id="gridResultTarget"></div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
$(function () {
    $("#tabstrip").kendoTabStrip({
        animation:  {
            open: {
                effects: "fadeIn"
            }
        }
    });


    var dsArea = new kendo.data.DataSource({
        dataSource: []
    });

    var dsGroup = new kendo.data.DataSource({
        dataSource: []
    });

    var dsUser = new kendo.data.DataSource({
        dataSource: []
    });

    var sessionId = +$('meta[name="_sessionId"]').attr('content');
    var ddl_area, ddl_group, ddl_user;
    $.$ajax({
        url: '/performance/json-area-group-user-data',
        type: 'GET',
        dataType: 'json',
        success: function (res) {
            console.log(res);
            //if (res.areas.length > 1) res.areas.unshift({id: '', a_name: '全部区域'});
            //if (res.groups.length > 1) res.groups.unshift({id: '', g_name: '全部项目组', area_id: 0, area_name: ''});
            //if (res.users.length > 1) res.users.unshift({id: '', nickname: '全体成员', area_id: 0, area_name: '', group_id: 0, group_name: ''});
            dsArea.data(res.areas);
            dsGroup.data(res.groups);
            dsUser.data(res.users);
            ddl_area = $('#search_area').kendoDropDownList(config.area).data('kendoDropDownList');
            ddl_group = $('#search_group').kendoDropDownList(config.group).data('kendoDropDownList');
            ddl_user = $('#search_user').kendoDropDownList(config.user).data('kendoDropDownList');
        }
    });

    var config = {
        area: {
            dataSource: dsArea,
            dataTextField: 'a_name',
            dataValueField: 'id',
            optionLabel: '全部区域',
            change: function () {
                var area_id = ~~this.value();
                dsGroup.filter({
                    logic: 'or',
                    filters: [
                        {field: 'area_id', operator: 'eq', value: area_id},
                        {field: 'area_id', operator: 'eq', value: 0},
                    ]
                });
                dsUser.filter({
                    logic: 'or',
                    filters: [
                        {field: 'area_id', operator: 'eq', value: area_id},
                        {field: 'area_id', operator: 'eq', value: 0},
                    ]
                });
            }
        },
        group: {
            dataSource: dsGroup,
            dataTextField: 'g_name',
            dataValueField: 'id',
            optionLabel: '全部项目组',
            template: '#:g_name##:area_name ? " [" + area_name + "]" : ""#',
            change: function () {
                var group_id = ~~this.value();
                dsUser.filter({
                    logic: 'or',
                    filters: [
                        {field: 'group_id', operator: 'eq', value: group_id},
                        {field: 'group_id', operator: 'eq', value: 0},
                    ]
                });
            }
        },
        user: {
            dataSource: dsUser,
            dataTextField: 'nickname',
            dataValueField: 'id',
            optionLabel: '全体成员'
        }
    };

    var sdate = $('#sdate').kendoDatePicker({
        culture: 'zh-CN',
        format: 'yyyy-MM',
        depth: 'year',
        start: 'year',
        value: new Date(),
        change: function () {
            edate.min(this.value());
            edate.max(this.value().translate('now+365'));
            if (!edate.value()) {
                sdate.max(this.value());
                sdate.min(this.value().translate('now-365'));
                edate.value(this.value());
            }
        }
    }).data('kendoDatePicker');
    var edate = $('#edate').kendoDatePicker({
        culture: 'zh-CN',
        format: 'yyyy-MM',
        depth: 'year',
        start: 'year',
        value: new Date(),
        change: function () {
            sdate.max(this.value());
            sdate.min(this.value().translate('now-365'));
            if (!sdate.value()) {
                edate.min(this.value());
                edate.max(this.value().translate('now+365'));
                sdate.value(this.value());
            }
        }
    }).data('kendoDatePicker');

    $('#search').click(function () {
        var data = {}, area = $('#search_area').val(), group = $('#search_group').val(), user = $('#search_user').val()
        var sdate = new Date($('#sdate').val());
        var edate = new Date($('#edate').val());
        data.sdate = new Date(sdate.getFullYear(), sdate.getMonth(), 1).format();
        data.edate = new Date(edate.getFullYear(), edate.getMonth() + 1, 0).format();
        data.area = area;
        data.group = group;
        data.user = user;
        console.log(data);
        $.$ajax({
            url: '/performance/json-performance-search',
            type: 'GET',
            dataType: 'json',
            data: data,
            success: function (res) {
                buildGridData(res);
//                grid.dataSource.data(res);
            }
        })
    });

    $('#search').trigger('click');

    function buildGridData(data) {
        var target_data = data.target.map(function (v) {
            var bd_count = getCountData(v, data.bd),
                person_count = getCountData(v, data.person),
                report_count = getCountData(v, data.report),
                face_count = getCountData(v, data.face),
                offer_count = getCountData(v, data.offer),
                success_count = getCountData(v, data.success),
                result_count = getCountData(v, data.result);

            return {
                user_id: v.user_id,
                nickname: v.nickname,
                month: v.month,
                bd: {
                    target: v.bd_target,
                    count: bd_count
                },
                person: {
                    target: v.person_target,
                    count: person_count
                },
                report: {
                    target: v.report_target,
                    count: report_count
                },
                face: {
                    target: v.face_target,
                    count: face_count
                },
                offer: {
                    target: v.offer_target,
                    count: offer_count
                },
                success: {
                    target: v.success_target,
                    count: success_count
                },
                result: {
                    target: v.result_target,
                    count: result_count
                }
            }
        });
        grid.dataSource.data(target_data);
    }

    function getCountData(v, data) {
        var count = 0;
        for (var i = 0; i < data.length; i++) {
            var d = data[i];
            if (d.month == v.month && d.user_id == v.user_id) {
                count = d.count;
                break;
            }
        }
        return count;
    }

    var grid = $('#grid').kendoGrid({
        dataSource: {
            data: [],
            pageSize: 10
        },
        scrollable: false,
        pageable: true,
        columns: [
            {field: 'nickname', title: '顾问'},
            {field: 'month', title: '目标月份', template: editMonth},
            {title: '<div class=\'text-center\'>BD签约</div>', columns: [
                {field: 'bd.target', title: '目标量'},
                {field: 'bd.count', title: '完成量'},
                {title: '完成率', template: getPercent('bd')}
            ]},
            {title: '<div class=\'text-center\'>人选录入</div>', columns: [
                {field: 'person.target', title: '目标量'},
                {field: 'person.count', title: '完成量'},
                {title: '完成率', template: getPercent('person')}
            ]},
            {title: '<div class=\'text-center\'>推荐报告</div>', columns: [
                {field: 'report.target', title: '目标量'},
                {field: 'report.count', title: '完成量'},
                {title: '完成率', template: getPercent('report')}
            ]},
            {title: '<div class=\'text-center\'>企业面试</div>', columns: [
                {field: 'face.target', title: '目标量'},
                {field: 'face.count', title: '完成量'},
                {title: '完成率', template: getPercent('face')}
            ]},
            {title: '<div class=\'text-center\'>Offer</div>', columns: [
                {field: 'offer.target', title: '目标量'},
                {field: 'offer.count', title: '完成量'},
                {title: '完成率', template: getPercent('offer')}
            ]},
            {title: '<div class=\'text-center\'>入职上岗</div>', columns: [
                {field: 'success.target', title: '目标量'},
                {field: 'success.count', title: '完成量'},
                {title: '完成率', template: getPercent('success')}
            ]},
            // {title: '<div class=\'text-center\'>回款业绩</div>', columns: [
            //     {field: 'result.target', title: '目标量', template: '#:result.target#W'},
            //     {field: 'result.count', title: '完成量'},
            //     {title: '完成率', template: getPercent('result')}
            // ]},
            //{title: '操作', template: '<a class="btn btn-xs btn-warning"><i class="fa fa-pencil"></i></a>'}
        ]
    }).data('kendoGrid');

    function getPercent(field) {
        return function (item) {
            var target = item[field].target;
            if (target > 0) {
                if (field == 'result') target = target * 10000;
                var percent = item[field].count / target;
                if (percent < 1) {
                    return '<span class="red">{0}</span>'.format(kendo.toString(percent, 'p1'));
                } else {
                    return '<span class="green">{0}</span>'.format(kendo.toString(percent, 'p1'));
                }
            } else {
                return '<span class="dark-gray">--</span>';
            }
        }
    }

    function editMonth(item) {
        if (sessionId == item.user_id && new Date(item.month).getTime() > Date.now()) {
            return '<a class="_edit text-primary pointer">{0}</a>'.format(item.month, item.user_id);
        } else {
            return item.month;
        }
    }

    $('#grid').delegate('a._edit', 'click', function () {
        var self = $(this), item = grid.dataItem(self.closest('tr'));
        var data = {
            user_id: item.user_id,
            month: item.month,
            bd: item['bd'].target,
            person: item['person'].target,
            report: item['report'].target,
            face: item['face'].target,
            offer: item['offer'].target,
            success: item['success'].target,
            result: item['result'].target,
        }
        initDialog(data);
    });

    $('#add').click(function () {
        initDialog();
    });

    function initDialog(data) {
        $.$modal.dialog({
            title: '{0}目标'.format(data ? '修改' : '新增'),
            destroy: true,
            content: '' +
            '<div>' +
                '<div class="flex"><span class="form-control-static">目标月份：</span><span class="flex-1"><input type="text" id="month" /></span></div>' +
                '<div class="margin-top-10 margin-bottom-5"><b class="form-control-static">目标设定</b></div>' +
                '<div class="flex margin-bottom-5">' +
                    '<div class="flex-1 flex margin-right-10"><span class="width-50 text-right form-control-static padding-right-5">BD：</span><span class="flex-1"><div class="input-group"><input type="text" class="form-control int" id="bd" /><span class="input-group-addon">个</span></div></span></div>' +
                    '<div class="flex-1 flex margin-right-10"><span class="width-50 text-right form-control-static padding-right-5">人选：</span><span class="flex-1"><div class="input-group"><input type="text" class="form-control int" id="person" /><span class="input-group-addon">人</span></div></span></div>' +
                    '<div class="flex-1 flex margin-right-10"><span class="width-50 text-right form-control-static padding-right-5">报告：</span><span class="flex-1"><div class="input-group"><input type="text" class="form-control int" id="report" /><span class="input-group-addon">份</span></div></span></div>' +
                '</div>' +
                '<div class="flex margin-bottom-5">' +
                    '<div class="flex-1 flex margin-right-10"><span class="width-50 text-right form-control-static padding-right-5">面试：</span><span class="flex-1"><div class="input-group"><input type="text" class="form-control int" id="face" /><span class="input-group-addon">个</span></div></span></div>' +
                    '<div class="flex-1 flex margin-right-10"><span class="width-50 text-right form-control-static padding-right-5">Offer：</span><span class="flex-1"><div class="input-group"><input type="text" class="form-control int" id="offer" /><span class="input-group-addon">个</span></div></span></div>' +
                    '<div class="flex-1 flex margin-right-10"><span class="width-50 text-right form-control-static padding-right-5">上岗：</span><span class="flex-1"><div class="input-group"><input type="text" class="form-control int" id="success" /><span class="input-group-addon">人</span></div></span></div>' +
                '</div>' +
                '<div class="flex margin-bottom-5">' +
                    '<div class="flex-1 flex margin-right-10"><span class="width-50 text-right form-control-static padding-right-5">业绩：</span><span class="flex-1"><div class="input-group"><input type="text" class="form-control int" id="result" /><span class="input-group-addon">万元</span></div></span></div>' +
                    '<div class="flex-1 margin-right-10"></div><div class="flex-1 margin-right-10"></div>' +
                '</div>' +
            '</div>',
            footer: {
                buttons: [
                    {
                        name: 'ok',
                        handler: function () {
                            var self = this, dom = self.dom, valid = true;
                            var month = {
                                month: $('#month', dom).val(),
                                bd: $('#bd', dom).val(),
                                person: $('#person', dom).val(),
                                report: $('#report', dom).val(),
                                face: $('#face', dom).val(),
                                offer: $('#offer', dom).val(),
                                success: $('#success', dom).val(),
                                result: $('#result', dom).val(),
                            }
                            for (var n in month) {
                                if (month[n] === '') {
                                    valid = false;
                                }
                            }
                            if (!valid) {
                                $.$modal.alert('不能有空值!');
                                return;
                            }
                            $.$ajax({
                                url: '/performance/save-target',
                                type: 'POST',
                                data: {month: month},
                                dataType: 'json',
                                success: function (res) {
                                    if (res == 1) {
                                        $.$modal.alert('保存成功!');
                                        self.hide();
                                        if (data) {
                                            $('#search').trigger('click');
                                        }
                                    }
                                }
                            });
                        }
                    },
                    {
                        name: 'cancel',
                        handler: function () {
                            this.hide();
                        }
                    }
                ]
            },
            onLoaded: function () {
                var self = this, dom = self.dom;
                $('#month', dom).kendoDatePicker({
                    culture: 'zh-CN',
                    format: 'yyyy-MM',
                    depth: 'year',
                    start: 'year',
                    min: new Date(),
                    value: data ? new Date(data.month) : new Date()
                });
                $('input.int', dom).each(function (i, ipt) {
                    var id = $(ipt).attr('id');
                    $(ipt).kendoNumericTextBox({
                        spinners: false,
                        decimal: 0,
                        format: '',
                        min: 0,
                        value: data ? data[id] : 0
                    });
                });
            }
        }).show();
    }


    /*******************************业绩目标***************************************/

    $('#gridResultTarget').kendoGrid({
        dataSource: {
            data: []
        },
        scrollable: false,
        pageable: true,
        columns: [
            {field: 'start_date', 'title': '目标时间'},
            {field: 'result_target', 'title': '目标额度'},
        ]
    });
});
</script>