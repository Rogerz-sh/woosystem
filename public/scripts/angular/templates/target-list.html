<style>
tbody tr:nth-child(2n) td {background: #f9f9f9;}
.k-grid tbody tr td {border-width: 1px 0 0 1px;}
</style>
<div class="wrapper bg-white padding-15 margin-top-20 margin-bottom-50 box-shadow">
    <div class="container-fluid">
        <div class="row">
            <ul class="breadcrumb">
                <li><a href="#/">首页</a></li>
                <li>目标管理</li>
            </ul>
        </div>
        <div id="tabstrip">
            <ul>
                <li class="k-state-active">KPI目标</li>
                <li>业绩目标</li>
            </ul>
            <div>
                <div class="row margin-bottom-10 margin-top-10">
                    <div class="col-xs-1"><a class="btn btn-sm btn-success" id="add"><i class="fa fa-plus"></i> 新增KPI目标</a></div>
                </div>
                <div class="row margin-bottom-10">
                    <div class="col-xs-12">
                        <div class="pull-left">
                            <div class="pull-left margin-left-10 form-control-static">查询月份：</div>
                            <div class="pull-left margin-left-10"><input type="text" id="sdate" class="size-120" placeholder="开始月份"></div>
                            <div class="pull-left margin-left-10 form-control-static"> ~ </div>
                            <div class="pull-left margin-left-10"><input type="text" id="edate" class="size-120" placeholder="结束月份"></div>
                        </div>
                        <div class="pull-left margin-left-20"><select id="search_area"></select></div>
                        <div class="pull-left margin-left-20"><select id="search_group"></select></div>
                        <div class="pull-left margin-left-20"><select id="search_user"></select></div>
                        <div class="pull-left margin-left-10">
                            <button class="btn btn-xs btn-primary" id="search"><i class="fa fa-search"></i> 查询</button>
                        </div>
                    </div>
                </div>
                <div class="row margin-bottom-10">
                    <div class="col-xs-12">
                        <div class="bordered border-color-gray"><div id="grid"></div></div>
                    </div>
                </div>
                <div class="row margin-bottom-10">
                    <div class="col-xs-12">
                        提示：月份颜色显示为蓝色时可点击编辑（自己的目标并且目标月份尚未开始才可以编辑哦）
                    </div>
                </div>
            </div>
            <div>
                <div class="row margin-bottom-10 margin-top-10">
                    <div class="col-xs-1"><a class="btn btn-sm btn-success" id="addResultTarget"><i class="fa fa-plus"></i> 新增业绩目标</a></div>
                </div>
                <div class="row margin-bottom-10">
                    <div class="col-xs-12">
                        <div class="pull-left">
                            <div class="pull-left margin-left-10 form-control-static">查询年份：</div>
                            <div class="pull-left margin-left-10"><select class="width-80" id="syear"></select></div>
                        </div>
                        <div class="pull-left margin-left-10">
                            <div class="btn-group btn-group-xs">
                                <button class="btn btn-default active" data-range="全年">全年</button>
                                <button class="btn btn-default" data-range="上半年">上半年</button>
                                <button class="btn btn-default" data-range="下半年">下半年</button>
                            </div>
                        </div>
                        <div class="pull-left margin-left-20"><select id="search_areas"></select></div>
                        <div class="pull-left margin-left-20"><select id="search_groups"></select></div>
                        <div class="pull-left margin-left-20"><select id="search_users"></select></div>
                        <div class="pull-left margin-left-10">
                            <button class="btn btn-xs btn-primary" id="searchs"><i class="fa fa-search"></i> 查询</button>
                        </div>
                    </div>
                </div>
                <div class="row margin-bottom-10">
                    <div class="col-xs-12">
                        <div class="padding-left-10 dark-orange bold">总完成率： <span id="percent_total"></span>（<span id="result_total"></span> / <span id="target_total"></span>）</div>
                    </div>
                </div>
                <div class="row margin-bottom-10">
                    <div class="col-xs-12">
                        <div class="bordered border-color-gray"><div id="gridResultTarget"></div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
$(function () {
    $("#tabstrip").kendoTabStrip({
        animation:  {
            open: {
                effects: "fadeIn"
            }
        }
    });


    var dsArea = new kendo.data.DataSource({
        dataSource: []
    });

    var dsGroup = new kendo.data.DataSource({
        dataSource: []
    });

    var dsUser = new kendo.data.DataSource({
        dataSource: []
    });


    var dsAreas = new kendo.data.DataSource({
        dataSource: []
    });

    var dsGroups = new kendo.data.DataSource({
        dataSource: []
    });

    var dsUsers = new kendo.data.DataSource({
        dataSource: []
    });

    var sessionId = +$('meta[name="_sessionId"]').attr('content');
    $.$ajax({
        url: '/performance/json-area-group-user-data',
        type: 'GET',
        dataType: 'json',
        success: function (res) {
            console.log(res);
            dsArea.data(res.areas);
            dsGroup.data(res.groups);
            dsUser.data(res.users);
            dsAreas.data(res.areas);
            dsGroups.data(res.groups);
            dsUsers.data(res.users);
            $('#search_area').kendoDropDownList(config.area).data('kendoDropDownList');
            $('#search_group').kendoDropDownList(config.group).data('kendoDropDownList');
            $('#search_user').kendoDropDownList(config.user).data('kendoDropDownList');
            $('#search_areas').kendoDropDownList(config.area).data('kendoDropDownList');
            $('#search_groups').kendoDropDownList(config.group).data('kendoDropDownList');
            $('#search_users').kendoDropDownList(config.user).data('kendoDropDownList');
        }
    });

    var config = {
        area: {
            dataSource: dsArea,
            dataTextField: 'a_name',
            dataValueField: 'id',
            optionLabel: '全部区域',
            change: function () {
                var area_id = ~~this.value();
                dsGroup.filter({
                    logic: 'or',
                    filters: [
                        {field: 'area_id', operator: 'eq', value: area_id},
                        {field: 'area_id', operator: 'eq', value: 0},
                    ]
                });
                dsUser.filter({
                    logic: 'or',
                    filters: [
                        {field: 'area_id', operator: 'eq', value: area_id},
                        {field: 'area_id', operator: 'eq', value: 0},
                    ]
                });
            }
        },
        group: {
            dataSource: dsGroup,
            dataTextField: 'g_name',
            dataValueField: 'id',
            optionLabel: '全部项目组',
            template: '#:g_name##:area_name ? " [" + area_name + "]" : ""#',
            change: function () {
                var group_id = ~~this.value();
                dsUser.filter({
                    logic: 'or',
                    filters: [
                        {field: 'group_id', operator: 'eq', value: group_id},
                        {field: 'group_id', operator: 'eq', value: 0},
                    ]
                });
            }
        },
        user: {
            dataSource: dsUser,
            dataTextField: 'nickname',
            dataValueField: 'id',
            optionLabel: '全体成员'
        },
        areas: {
            dataSource: dsAreas,
            dataTextField: 'a_name',
            dataValueField: 'id',
            optionLabel: '全部区域',
            change: function () {
                var area_id = ~~this.value();
                dsGroups.filter({
                    logic: 'or',
                    filters: [
                        {field: 'area_id', operator: 'eq', value: area_id},
                        {field: 'area_id', operator: 'eq', value: 0},
                    ]
                });
                dsUsers.filter({
                    logic: 'or',
                    filters: [
                        {field: 'area_id', operator: 'eq', value: area_id},
                        {field: 'area_id', operator: 'eq', value: 0},
                    ]
                });
            }
        },
        groups: {
            dataSource: dsGroups,
            dataTextField: 'g_name',
            dataValueField: 'id',
            optionLabel: '全部项目组',
            template: '#:g_name##:area_name ? " [" + area_name + "]" : ""#',
            change: function () {
                var group_id = ~~this.value();
                dsUsers.filter({
                    logic: 'or',
                    filters: [
                        {field: 'group_id', operator: 'eq', value: group_id},
                        {field: 'group_id', operator: 'eq', value: 0},
                    ]
                });
            }
        },
        users: {
            dataSource: dsUsers,
            dataTextField: 'nickname',
            dataValueField: 'id',
            optionLabel: '全体成员'
        }
    };

    var sdate = $('#sdate').kendoDatePicker({
        culture: 'zh-CN',
        format: 'yyyy-MM',
        depth: 'year',
        start: 'year',
        value: new Date(),
        change: function () {
            edate.min(this.value());
            edate.max(this.value().translate('now+365'));
            if (!edate.value()) {
                sdate.max(this.value());
                sdate.min(this.value().translate('now-365'));
                edate.value(this.value());
            }
        }
    }).data('kendoDatePicker');
    var edate = $('#edate').kendoDatePicker({
        culture: 'zh-CN',
        format: 'yyyy-MM',
        depth: 'year',
        start: 'year',
        value: new Date(),
        change: function () {
            sdate.max(this.value());
            sdate.min(this.value().translate('now-365'));
            if (!sdate.value()) {
                edate.min(this.value());
                edate.max(this.value().translate('now+365'));
                sdate.value(this.value());
            }
        }
    }).data('kendoDatePicker');

    $('#search').click(function () {
        var data = {}, area = $('#search_area').val(), group = $('#search_group').val(), user = $('#search_user').val()
        var sdate = new Date($('#sdate').val());
        var edate = new Date($('#edate').val());
        data.sdate = new Date(sdate.getFullYear(), sdate.getMonth(), 1).format();
        data.edate = new Date(edate.getFullYear(), edate.getMonth() + 1, 0).format();
        data.area = area;
        data.group = group;
        data.user = user;
        console.log(data);
        $.$ajax({
            url: '/performance/json-performance-search',
            type: 'GET',
            dataType: 'json',
            data: data,
            success: function (res) {
                buildGridData(res);
//                grid.dataSource.data(res);
            }
        })
    });

    $('#search').trigger('click');

    function buildGridData(data) {
        var target_data = data.target.map(function (v) {
            var bd_count = getCountData(v, data.bd),
                person_count = getCountData(v, data.person),
                report_count = getCountData(v, data.report),
                face_count = getCountData(v, data.face),
                offer_count = getCountData(v, data.offer),
                success_count = getCountData(v, data.success),
                result_count = getCountData(v, data.result);

            return {
                user_id: v.user_id,
                nickname: v.nickname,
                month: v.month,
                bd: {
                    target: v.bd_target,
                    count: bd_count
                },
                person: {
                    target: v.person_target,
                    count: person_count
                },
                report: {
                    target: v.report_target,
                    count: report_count
                },
                face: {
                    target: v.face_target,
                    count: face_count
                },
                offer: {
                    target: v.offer_target,
                    count: offer_count
                },
                success: {
                    target: v.success_target,
                    count: success_count
                },
                result: {
                    target: v.result_target,
                    count: result_count
                }
            }
        });
        grid.dataSource.data(target_data);
    }

    function getCountData(v, data) {
        var count = 0;
        for (var i = 0; i < data.length; i++) {
            var d = data[i];
            if (d.month == v.month && d.user_id == v.user_id) {
                count = d.count;
                break;
            }
        }
        return count;
    }

    var grid = $('#grid').kendoGrid({
        dataSource: {
            data: [],
            pageSize: 10
        },
        scrollable: false,
        pageable: true,
        columns: [
            {field: 'nickname', title: '顾问'},
            {field: 'month', title: '目标月份', template: editMonth},
            {title: '<div class=\'text-center\'>BD签约</div>', columns: [
                {field: 'bd.target', title: '目标量'},
                {field: 'bd.count', title: '完成量'},
                {title: '完成率', template: getPercent('bd')}
            ]},
            {title: '<div class=\'text-center\'>人选录入</div>', columns: [
                {field: 'person.target', title: '目标量'},
                {field: 'person.count', title: '完成量'},
                {title: '完成率', template: getPercent('person')}
            ]},
            {title: '<div class=\'text-center\'>推荐报告</div>', columns: [
                {field: 'report.target', title: '目标量'},
                {field: 'report.count', title: '完成量'},
                {title: '完成率', template: getPercent('report')}
            ]},
            {title: '<div class=\'text-center\'>企业面试</div>', columns: [
                {field: 'face.target', title: '目标量'},
                {field: 'face.count', title: '完成量'},
                {title: '完成率', template: getPercent('face')}
            ]},
            {title: '<div class=\'text-center\'>Offer</div>', columns: [
                {field: 'offer.target', title: '目标量'},
                {field: 'offer.count', title: '完成量'},
                {title: '完成率', template: getPercent('offer')}
            ]},
            {title: '<div class=\'text-center\'>入职上岗</div>', columns: [
                {field: 'success.target', title: '目标量'},
                {field: 'success.count', title: '完成量'},
                {title: '完成率', template: getPercent('success')}
            ]},
            // {title: '<div class=\'text-center\'>回款业绩</div>', columns: [
            //     {field: 'result.target', title: '目标量', template: '#:result.target#W'},
            //     {field: 'result.count', title: '完成量'},
            //     {title: '完成率', template: getPercent('result')}
            // ]},
            //{title: '操作', template: '<a class="btn btn-xs btn-warning"><i class="fa fa-pencil"></i></a>'}
        ]
    }).data('kendoGrid');

    function getPercent(field) {
        return function (item) {
            var target = item[field].target;
            if (target > 0) {
                if (field == 'result') target = target * 10000;
                var percent = item[field].count / target;
                if (percent < 1) {
                    return '<span class="red">{0}</span>'.format(kendo.toString(percent, 'p1'));
                } else {
                    return '<span class="green">{0}</span>'.format(kendo.toString(percent, 'p1'));
                }
            } else {
                return '<span class="dark-gray">--</span>';
            }
        }
    }

    function editMonth(item) {
        if (sessionId == item.user_id && new Date(item.month).getTime() > Date.now()) {
            return '<a class="_edit text-primary pointer">{0}</a>'.format(item.month, item.user_id);
        } else {
            return item.month;
        }
    }

    $('#grid').delegate('a._edit', 'click', function () {
        var self = $(this), item = grid.dataItem(self.closest('tr'));
        var data = {
            user_id: item.user_id,
            month: item.month,
            bd: item['bd'].target,
            person: item['person'].target,
            report: item['report'].target,
            face: item['face'].target,
            offer: item['offer'].target,
            success: item['success'].target,
            result: item['result'].target,
        }
        initDialog(data);
    });

    $('#add').click(function () {
        initDialog();
    });

    function initDialog(data) {
        $.$modal.dialog({
            title: '{0}目标'.format(data ? '修改' : '新增'),
            destroy: true,
            content: '' +
            '<div>' +
                '<div class="flex"><span class="form-control-static">目标月份：</span><span class="flex-1"><input type="text" id="month" /></span></div>' +
                '<div class="margin-top-10 margin-bottom-5"><b class="form-control-static">目标设定</b></div>' +
                '<div class="flex margin-bottom-5">' +
                    '<div class="flex-1 flex margin-right-10"><span class="width-50 text-right form-control-static padding-right-5">BD：</span><span class="flex-1"><div class="input-group"><input type="text" class="form-control int" id="bd" /><span class="input-group-addon">个</span></div></span></div>' +
                    '<div class="flex-1 flex margin-right-10"><span class="width-50 text-right form-control-static padding-right-5">人选：</span><span class="flex-1"><div class="input-group"><input type="text" class="form-control int" id="person" /><span class="input-group-addon">人</span></div></span></div>' +
                    '<div class="flex-1 flex margin-right-10"><span class="width-50 text-right form-control-static padding-right-5">报告：</span><span class="flex-1"><div class="input-group"><input type="text" class="form-control int" id="report" /><span class="input-group-addon">份</span></div></span></div>' +
                '</div>' +
                '<div class="flex margin-bottom-5">' +
                    '<div class="flex-1 flex margin-right-10"><span class="width-50 text-right form-control-static padding-right-5">面试：</span><span class="flex-1"><div class="input-group"><input type="text" class="form-control int" id="face" /><span class="input-group-addon">个</span></div></span></div>' +
                    '<div class="flex-1 flex margin-right-10"><span class="width-50 text-right form-control-static padding-right-5">Offer：</span><span class="flex-1"><div class="input-group"><input type="text" class="form-control int" id="offer" /><span class="input-group-addon">个</span></div></span></div>' +
                    '<div class="flex-1 flex margin-right-10"><span class="width-50 text-right form-control-static padding-right-5">上岗：</span><span class="flex-1"><div class="input-group"><input type="text" class="form-control int" id="success" /><span class="input-group-addon">人</span></div></span></div>' +
                '</div>' +
                '<div class="flex margin-bottom-5">' +
                    '<div class="flex-1 flex margin-right-10"><span class="width-50 text-right form-control-static padding-right-5">业绩：</span><span class="flex-1"><div class="input-group"><input type="text" class="form-control int" id="result" /><span class="input-group-addon">万元</span></div></span></div>' +
                    '<div class="flex-1 margin-right-10"></div><div class="flex-1 margin-right-10"></div>' +
                '</div>' +
            '</div>',
            footer: {
                buttons: [
                    {
                        name: 'ok',
                        handler: function () {
                            var self = this, dom = self.dom, valid = true;
                            var month = {
                                month: $('#month', dom).val(),
                                bd: $('#bd', dom).val(),
                                person: $('#person', dom).val(),
                                report: $('#report', dom).val(),
                                face: $('#face', dom).val(),
                                offer: $('#offer', dom).val(),
                                success: $('#success', dom).val(),
                                result: $('#result', dom).val(),
                            }
                            for (var n in month) {
                                if (month[n] === '') {
                                    valid = false;
                                }
                            }
                            if (!valid) {
                                $.$modal.alert('不能有空值!');
                                return;
                            }
                            $.$ajax({
                                url: '/performance/save-target',
                                type: 'POST',
                                data: {month: month},
                                dataType: 'json',
                                success: function (res) {
                                    if (res == 1) {
                                        $.$modal.alert('保存成功!');
                                        self.hide();
                                        if (data) {
                                            $('#search').trigger('click');
                                        }
                                    }
                                }
                            });
                        }
                    },
                    {
                        name: 'cancel',
                        handler: function () {
                            this.hide();
                        }
                    }
                ]
            },
            onLoaded: function () {
                var self = this, dom = self.dom;
                $('#month', dom).kendoDatePicker({
                    culture: 'zh-CN',
                    format: 'yyyy-MM',
                    depth: 'year',
                    start: 'year',
                    min: new Date(),
                    value: data ? new Date(data.month) : new Date()
                });
                $('input.int', dom).each(function (i, ipt) {
                    var id = $(ipt).attr('id');
                    $(ipt).kendoNumericTextBox({
                        spinners: false,
                        decimal: 0,
                        format: '',
                        min: 0,
                        value: data ? data[id] : 0
                    });
                });
            }
        }).show();
    }


    /*******************************业绩目标***************************************/
    $('#syear').kendoDropDownList({
        dataSource: {
            data: (function () {
                var years = [];
                for (var i = 2018; i < 2100; i ++) {
                    years.push(i + '');
                }
                return years;
            })()
        },
        value: (new Date()).getFullYear()
    });

    $('div.btn-group').delegate('button[data-range]', 'click', function () {
        var range = $(this).data('range');
        $(this).addClass('active').siblings().removeClass('active');
    });

    $('#searchs').click(function () {
        var data = {}, area = $('#search_areas').val(), group = $('#search_groups').val(), user = $('#search_users').val()
        var range = $('button[data-range].active').data('range');
        data.year = $('#syear').val();
        data.range = range;
        data.area = area;
        data.group = group;
        data.user = user;
        console.log(data);
        $.$ajax({
            url: '/performance/result-target-search',
            type: 'GET',
            dataType: 'json',
            data: data,
            success: function (res) {
                var result_total = 0, target_total = 0, percent_total = '---%';
                res.forEach(function (v) {
                    v.result_count = +v.result_count;
                    result_total += v.result_count;
                    target_total += v.target;
                });
                $('#target_total').text(kendo.toString(target_total, 'n2') + '元');
                $('#result_total').text(kendo.toString(result_total, 'n2') + '元');
                if (target_total > 0) percent_total = kendo.toString(result_total / target_total, 'p2');
                $('#percent_total').text(percent_total);
                gridResultTarget.dataSource.data(res);
            }
        })
    });

    $('#searchs').trigger('click');

    var gridResultTarget = $('#gridResultTarget').kendoGrid({
        dataSource: {
            data: [],
            schema: {
                model: {
                    id: 'id'
                }
            },
            pageSize: 10,
        },
        scrollable: false,
        pageable: true,
        columns: [
            {field: 'nickname', 'title': '顾问'},
            {field: 'group_name', 'title': '项目组'},
            {field: 'area_name', 'title': '区域'},
            {field: 'year', 'title': '目标年度'},
            {field: 'area', 'title': '目标区间', template: showArea},
            {field: 'target', 'title': '目标额度', template: '#:kendo.toString(target, "n2")#'},
            {field: 'result_count', 'title': '完成额度', template: '#:kendo.toString(result_count, "n2")#'},
            {'title': '完成率', template: '#:kendo.toString(result_count/target, "p2")#'},
            {
                title: '操作',
                template: getButtons
            }
        ]
    }).data('kendoGrid');

    function showArea(item) {
        return item.area == '1' ? '<span class="green">上半年</span>' : '<span class="red">下半年</span>';
    }

    function getButtons(item) {
        var now = new Date(), year = now.getFullYear(), area = now.getMonth() < 6 ? 1 : 2, disabled = '';
        if (+item.year < year || (+item.year == year && +item.area < area)) {
            disabled = 'disabled';
        }
        return '<a class="btn btn-xs btn-default _edit" data-id="{0}" {1}>编辑</a>\
                <a class="btn btn-xs btn-danger margin-left-5 _delete" data-id="{0}" {1}>删除</a>'.format(item.id, disabled)
    }

    $('#addResultTarget').click(function () {
        initResultTargetDialog();
    });

    $('#gridResultTarget').delegate('a._edit', 'click', function () {
        var id = $(this).data('id'), item = gridResultTarget.dataSource.get(id);
        initResultTargetDialog(item);
    });

    $('#gridResultTarget').delegate('a._delete', 'click', function () {
        var id = $(this).data('id');
        $.$modal.confirm(['删除目标', '确定要删除吗？'], function (isOk) {
            if (!isOk) return;
            $.$ajax({
                url: '/performance/delete-result-target',
                type: 'POST',
                dataType: 'json',
                data: {id: id},
                success: function (res) {
                    if (res == 1) {
                        gridResultTarget.dataSource.pushDestroy({id: id});
                    } else {
                        $.$modal.alert('删除失败');
                    }
                }
            });
        })
    });

    function initResultTargetDialog(item) {
        $.$modal.dialog({
            title: '{0}业绩目标'.format(item ? '修改' : '新增'),
            content: '<div class="row"><div class="col-xs-12">' +
                '<form class="form-horizontal">' +
                '<div class="form-group">' +
                '<label class="control-label col-xs-3">选择年度：</label>' +
                '<div class="col-xs-8"><select id="year"></select></div> ' +
                '</div>' +
                '<div class="form-group">' +
                '<label class="control-label col-xs-3">选择区间：</label>' +
                '<div class="col-xs-8">' +
                '<div class="col-xs-6 no-padding-left"><label class="form-control-static"><input type="radio" checked name="area" value="1" /><span class="text">上半年</span> </label></div>' +
                '<div class="col-xs-6 no-padding-left"><label class="form-control-static"><input type="radio" name="area" value="2" /><span class="text">下半年</span> </label></div>' +
                '</div> ' +
                '</div>' +
                '<div class="form-group">' +
                '<label class="control-label col-xs-3">目标额度：</label>' +
                '<div class="col-xs-8">' +
                '<div class="input-group"><input type="text" class="form-control" id="target" /><span class="input-group-addon">元</span></div>' +
                '</div> ' +
                '</div>' +
                '</form>' +
                '</div></div>',
            destroy: true,
            footer: {
                buttons: [
                    {
                        name: 'ok',
                        handler: function () {
                            var self = this, dom = self.dom;
                            var data = {
                                year: $('#year', dom).val(),
                                area: $('input[name="area"]:checked').val(),
                                target: $('#target', dom).data('kendoNumericTextBox').value()
                            }
                            if (item) {
                                data.id = item.id;
                                data.user_id = item.user_id;
                            }
                            console.log(data);
                            if (data.target < 10000) {
                                $.$modal.alert('设置的目标值过小');
                                return;
                            }
                            $.$ajax({
                                url: '/performance/{0}-result-target'.format(item ? 'edit' : 'save'),
                                type: 'POST',
                                dataType: 'json',
                                data: data,
                                success: function (res) {
                                    if (res == 1) {
                                        self.hide();
                                        $('#searchs').trigger('click');
                                    } else if (res == -1) {
                                        $.$modal.alert('不要重复录入');
                                    } else {
                                        $.$modal.alert('保存失败');
                                    }
                                }
                            });
                        }
                    },
                    {
                        name: 'cancel',
                        handler: function () {
                            this.hide();
                        }
                    }
                ]
            },
            onLoaded: function () {
                var self = this, dom = self.dom;
                $('#year', dom).kendoDropDownList({
                    dataSource: {
                        data: (function () {
                            var years = [];
                            for (var i = 2018; i < 2100; i ++) {
                                years.push(i + '');
                            }
                            return years;
                        })()
                    },
                    value: item ? item.year : (new Date()).getFullYear()
                });
                $('#target', dom).kendoNumericTextBox({
                    spinners: false,
                    min: 0,
                    decimals: 0,
                    format: 'n2',
                    value: item ? item.target : 0
                });
                if (item) {
                    $('input[name="area"][value="{0}"]'.format(item.area)).prop('checked', true);
                }
            }
        }).show();
    }
});
</script>